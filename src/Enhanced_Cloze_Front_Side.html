<div id="card-body">
    <div id="topic-section-win" class="header header-red topic-section">
        <table>
            <tr>
                <td rowspan="2">
                    <img src="_ui_mark.png" id="star" class="marked img-no-border">
                    <div id="domain-icon"></div>
                </td>
                <td>
                    {{#Domain}}
                    <div id="domain">@ {{Domain}}</div>
                    {{/Domain}}
                </td>
            </tr>
            <tr>
                <td>
                    {{#Topic}}
                    <span id="topic"># {{Topic}}</span>
                    {{/Topic}}
                    <!-- // -->

                    {{#Keyword}}
                    <span id="keyword">// {{Keyword}}</span>
                    {{/Keyword}}
                </td>
            </tr>
        </table>
    </div>

    <div id="topic-section-mobile" class="header header-red topic-section">
        {{#Domain}}
        <span id="domain">@ {{Domain}}</span>
        {{/Domain}}
        <!-- // -->

        {{#Topic}}
        <span id="topic"># {{Topic}}</span>
        {{/Topic}}
        <!-- // -->

        {{#Keyword}}
        <span id="keyword">// {{Keyword}}</span>
        {{/Keyword}}
    </div>

    <div id="main-section" class="content">
        {{cloze:Cloze1}} {{cloze:Cloze2}} {{cloze:Cloze3}} {{cloze:Cloze4}} {{cloze:Cloze5}} {{cloze:Cloze6}} {{cloze:Cloze7}} {{cloze:Cloze8}}
        {{cloze:Cloze9}} {{cloze:Cloze10}} {{cloze:Cloze11}} {{cloze:Cloze12}} {{cloze:Cloze13}} {{cloze:Cloze14}} {{cloze:Cloze15}}
        {{cloze:Cloze16}} {{cloze:Cloze17}} {{cloze:Cloze18}} {{cloze:Cloze19}} {{cloze:Cloze20}} {{cloze:Cloze21}} {{cloze:Cloze22}}
        {{cloze:Cloze23}} {{cloze:Cloze24}} {{cloze:Cloze25}} {{cloze:Cloze26}} {{cloze:Cloze27}} {{cloze:Cloze28}} {{cloze:Cloze29}}
        {{cloze:Cloze30}} {{cloze:Cloze31}} {{cloze:Cloze32}} {{cloze:Cloze33}} {{cloze:Cloze34}} {{cloze:Cloze35}} {{cloze:Cloze36}}
        {{cloze:Cloze37}} {{cloze:Cloze38}} {{cloze:Cloze39}} {{cloze:Cloze40}} {{cloze:Cloze41}} {{cloze:Cloze42}} {{cloze:Cloze43}}
        {{cloze:Cloze44}} {{cloze:Cloze45}} {{cloze:Cloze46}} {{cloze:Cloze47}} {{cloze:Cloze48}} {{cloze:Cloze49}} {{cloze:Cloze50}}
        {{cloze:Cloze51}} {{cloze:Cloze52}} {{cloze:Cloze53}} {{cloze:Cloze54}} {{cloze:Cloze55}} {{cloze:Cloze56}} {{cloze:Cloze57}}
        {{cloze:Cloze58}} {{cloze:Cloze59}} {{cloze:Cloze60}} {{cloze:Cloze61}} {{cloze:Cloze62}} {{cloze:Cloze63}} {{cloze:Cloze64}}
        {{cloze:Cloze65}} {{cloze:Cloze66}} {{cloze:Cloze67}} {{cloze:Cloze68}} {{cloze:Cloze69}} {{cloze:Cloze70}} {{cloze:Cloze71}}
        {{cloze:Cloze72}} {{cloze:Cloze73}} {{cloze:Cloze74}} {{cloze:Cloze75}} {{cloze:Cloze76}} {{cloze:Cloze77}} {{cloze:Cloze78}}
        {{cloze:Cloze79}} {{cloze:Cloze80}} {{cloze:Cloze81}} {{cloze:Cloze82}} {{cloze:Cloze83}} {{cloze:Cloze84}} {{cloze:Cloze85}}
        {{cloze:Cloze86}} {{cloze:Cloze87}} {{cloze:Cloze88}} {{cloze:Cloze89}} {{cloze:Cloze90}} {{cloze:Cloze91}} {{cloze:Cloze92}}
        {{cloze:Cloze93}} {{cloze:Cloze94}} {{cloze:Cloze95}} {{cloze:Cloze96}} {{cloze:Cloze97}} {{cloze:Cloze98}} {{cloze:Cloze99}}
        {{cloze:Cloze100}}
    </div>

    <br>

    <div id="info-section">
        <div id="info-header" class="header header-blue">
            信息
        </div>

        <div id="info" class="content" style="display:none">
            <div> 牌组: {{Deck}} </div>

            {{#Project}}
            <div> 项目: {{Project}} </div>
            {{/Project}}
            <!-- // -->

            {{#Tags}}
            <div id="tags"> 标签: {{Tags}} </div>
            {{/Tags}}
        </div>
    </div>

    <!-- // -->
    {{#Source}}
    <br>
    <div id="source-section">
        <div id="source-header" class="header header-green">
            来源
        </div>
        <div id="source" class="content" style="display:none">
            {{Source}}
        </div>
    </div>
    {{/Source}}

    <!-- // -->
    {{#Extra}}
    <br>
    <div id="extra-section">
        <div id="extra-header" class="header header-yellow">
            补充
        </div>
        <div id="extra" class="content" style="display:none">
            {{Extra}}
        </div>
    </div>
    {{/Extra}}

    <div id="notepad-section" style="display:none">
        <div id="notepad-header">
            <img src="_ui_handle.png" class="img-no-border">
        </div>
        <div id="notepad">
            <textarea></textarea>
        </div>
    </div>

    <div id="functional-elements">
        <div id="show-one-cloze-left"></div>
        <div id="show-one-cloze-right"></div>
        <div id="no-more-cloze"></div>
        <div id="show-all-pseudo-clozes"></div>
        <div style="display:none">
            {{type:In-use Clozes}}
        </div>
    </div>
</div>

<script src="_js_jquery-3.2.1.min.js"></script>
<script src="_js_jquery.hotkeys.js"></script>
<script src="_js_Autolinker.min.js"></script>
<script src="_js_jquery.visible.min.js"></script>
<script src="_js_jquery-ui.min.js"></script>

<script>
    var indexOfGenuineClozeToShow = 0;
    var genuineClozeTotalNumber = $('.genuine-cloze').length;
    var indexOfPseudoClozeToShow = 0;
    var pseudoClozeTotalNumber = $('.pseudo-cloze').length;
    var platform;

    $(function () {
        // get platform
        if ($('html.win').length) {
            platform = 'win';
        } else if ($('html.mobile').length) {
            platform = 'mobile'
        }

        // setup domain icons
        setDomainIcon();
        $('#domain-icon').effect('pulsate');

        // hide topic with #
        var $topic = $('#topic');
        var $keyword = $('#keyword');
        if ($topic.text().lastIndexOf('#')) {
            $topic.hide();
            $keyword.hide();
        }

        // wrap content block
        $('.content-block').each(function (index, elem) {
            if ($(elem).text().search(/\S/) !== -1) {
                $(elem).wrap('<div class="content-block-container"></div>')
            }
        })

        // initialize clozes
        $('.genuine-cloze, .pseudo-cloze').each(function (index, elem) {
            toggleCloze(elem, 'hint')
        });

        // shorten tags
        //      leaving only the last part if hierarchical tags are used, i.e. tag1::tag2::tag3 -> tag3
        $('#tags').each(function (index, elem) {
            $(elem).text($(elem).text().replace(/(\S+::)*/g, ''));
        });

        // generate link
        //      turn url-like plain text into clickable link
        $('#source').html(function (index, oldhtml) {
            return Autolinker.link(oldhtml, {
                phone: false,
                truncate: {
                    length: 100,
                    location: 'smart'
                },
                stripPrefix: false,
            })
        });

        // scroll to first cloze
        if (genuineClozeTotalNumber) {
            var $firstGenuineCloze = $('.genuine-cloze').first();
            $firstGenuineCloze.parents('.content-block').show();
            scrollToCloze($firstGenuineCloze.get(0))
        } else {
            $('.content-block').show()
        }

        // setup key binding
        $(document).bind('keyup', 'i', function () {
            showOneCloze();
        })

        $(document).bind('keyup', ',', function () {
            showOneCloze('pseudo');
        })

        $(document).bind('keyup', '.', function () {
            showAllPseudoClozes();
        })

        // setup cloze click event
        $('.genuine-cloze, .pseudo-cloze').click(function () {
            toggleCloze(this, 'toggle');
        });

        // setup hot area click event
        $('#show-one-cloze-left, #show-one-cloze-right').click(function () {
            showOneCloze();
        });

        // setup domain icon click event
        var $notepadSection = $('#notepad-section');
        $notepadSection.draggable();
        $('#domain-icon').click(function () {
            $notepadSection.toggle();
        })

        // setup header click event
        var headerIds = ['info-header', 'source-header', 'extra-header'];
        $.each(headerIds, function (index, id) {
            $elem = $('#' + id)
            $elem.click(function () {
                toggleNextElement(this)
            })
        })

    });


    function setDomainIcon() {
        var domainList = ['Android', 'CMD', 'CSS', 'HTML', 'Java', 'JavaScript', 'Python', 'SQL', 'Todoist', 'VIM',
            'jQuery'
        ]
        var domainMap = {
            '算法': 'algorithm',
        }

        var $domain = $('#domain');
        var domainText = $domain.text()
        var regexp = new RegExp('\\s*([^,@]+)(?=,|$)', 'g');
        for (var match; match = regexp.exec(domainText);) {
            var domain = match[1];
            if (domainList.indexOf(domain) !== -1) {
                addDomainIcon(domain)
            } else if (domainMap.hasOwnProperty(domain)) {
                addDomainIcon(domainMap[domain], domain)
            }
        }

        // if (!$('#domain-icon img').length) {
        //     addDomainIcon('Void')
        // }
    }

    function addDomainIcon(domain, title) {
        var title = (title) ? title : domain;
        var imgSrc = '_domain_' + domain.toLowerCase() + '.png';
        var imgElem = document.createElement('img');
        imgElem.src = imgSrc
        imgElem.title = title
        imgElem.className = 'img-no-border'
        $('#domain-icon').append(imgElem)
    }


    function scrollToCloze(elem) {
        var upperMargin = (platform === 'win') ? 200 : 150;

        $('html, body').animate({
            scrollTop: $(elem).offset().top - upperMargin
        }, 500);

        if (!$(elem).visible()) {
            $('html, body').animate({
                scrollLeft: $(elem).offset().left - $(window).width() + 100
            }, 500);
        }
    }

    function showOneCloze(mode) {
        if (mode !== 'pseudo') {
            if (indexOfGenuineClozeToShow >= genuineClozeTotalNumber) {
                $('#no-more-cloze').css('background-color', '#db4437').animate({
                    display: "toggle",
                }, 300);
            } else {
                $('.genuine-cloze[index=' + indexOfGenuineClozeToShow + ']').each(function (index, elem) {
                    showCloze(elem);
                })
            }
        } else {
            var shownPseudoClozeIndex = $('.pseudo-cloze[show-state="answer"]').last().attr('index');
            indexOfPseudoClozeToShow = shownPseudoClozeIndex !== undefined ? Number(shownPseudoClozeIndex) + 1 : 0;
            if (indexOfPseudoClozeToShow >= pseudoClozeTotalNumber) {
                $('#no-more-cloze').css('background-color', '#4285f4').animate({
                    display: "toggle",
                }, 300);
            } else {
                $('.pseudo-cloze[index=' + indexOfPseudoClozeToShow + ']').each(function (index, elem) {
                    showCloze(elem);
                })
            }
        }
    }

    function showCloze(elem) {
        var $elem = $(elem);
        $parentContentBlock = $elem.parents('.content-block:hidden')

        if ($parentContentBlock.length) {
            $parentContentBlock.show();
            if (!$elem.visible()) {
                scrollToCloze(elem);
            }
            return;
        }

        if (!$elem.visible()) {
            scrollToCloze(elem);
            return;
        }

        toggleCloze(elem, 'answer');

        if (!$elem.visible()) {
            scrollToCloze(elem);
        }

        $elem.hide();
        $elem.fadeIn(500);

        if ($elem.hasClass('genuine-cloze')) {
            indexOfGenuineClozeToShow++;
        } else {
            indexOfPseudoClozeToShow++;
        }
    }

    function showAllPseudoClozes() {
        $('.pseudo-cloze').each(function (index, elem) {
            toggleCloze(elem, 'answer');
        })
    }

    function toggleCloze(elem, option) {
        var answer = '';
        var hint = '';
        var answerText = '';
        var index = $(elem).attr('index');

        if ($(elem).hasClass('genuine-cloze')) {
            answer = $('#genuine-cloze-answer-' + index).html();
            hint = $('#genuine-cloze-hint-' + index).html();
            answerText = $('#genuine-cloze-answer-' + index).text();
        } else {
            answer = $('#pseudo-cloze-answer-' + index).html();
            hint = $('#pseudo-cloze-hint-' + index).html();
            answerText = $('#pseudo-cloze-answer-' + index).text();
        }

        var specialAnswerFlag = false;
        var specialAnswerModes = ['^//$', '^``$'];
        $.each(specialAnswerModes, function (index, mode) {
            var regexp = new RegExp(mode);
            if (answerText.match(regexp)) {
                specialAnswerFlag = true;
                return false;
            }
        })
        if (specialAnswerFlag) {
            hint = '&nbsp;' + answer + '&nbsp;';
        } else {
            hint = '&nbsp;[&nbsp;' + hint + '&nbsp;]&nbsp;';
        }

        switch (option) {
            case 'answer':
                $(elem).attr('show-state', 'answer');
                $(elem).html(answer);
                break;
            case 'hint':
                $(elem).attr('show-state', 'hint');
                $(elem).html(hint);
                break;
            case 'toggle':
                if ($(elem).attr('show-state') === 'hint') {
                    $(elem).attr('show-state', 'answer');
                    $(elem).html(answer);
                } else {
                    $(elem).attr('show-state', 'hint');
                    $(elem).html(hint);
                }
                break;
            default:
                break;
        }
    }

    function toggleNextElement(elem) {
        $(elem).next().toggle();
    };
</script>
<tt-s preset="NAVER Translate (en)" style="display: none">{{Domain}}</tts>